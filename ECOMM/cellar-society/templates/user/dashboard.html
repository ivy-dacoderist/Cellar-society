{% extends "user/base.html" %}

{% block title %}User Dashboard - Cellar Society{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Welcome, {{ customer_name or session.username }}!</h2>
    <p>You are now logged in to the Cellar Society User Dashboard.</p>
</div>

<div class="product-container">
  {% for product in products %}
    <div class="product-card"
         data-name="{{ product['name']|e }}"
         data-price="{{ "%.2f"|format(product['price']) }}"
         data-description="{{ product['description']|e }}"
         data-image="{{ product['image_url']|default('/static/default.png')|e }}"
         data-id="{{ product['id'] }}"
         onclick="openModal(this)">
      <div class="product-image">
        <img src="{{ product['image_url']|default('/static/default.png') }}" alt="{{ product['name'] }}">
      </div>
      <div class="product-info">
        <h3>{{ product['name'] }}</h3>
        <p class="price">₱{{ "%.2f"|format(product['price']) }}</p>
      </div>
    </div>
  {% else %}
    <p class="empty">No products available at the moment.</p>
  {% endfor %}
</div>

<!-- Overlay for blur effect -->
<div id="modalOverlay" class="modal-overlay" onclick="closeModal()"></div>
{% endblock %}

{% block styles %}
<style>
/* Product Grid */
.product-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

/* Product Card */
.product-card {
    background: var(--card-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    text-align: center;
    padding: 12px;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    z-index: 1;
}

.product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
}

.product-image img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 8px;
}

.product-info h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.1em;
    color: var(--primary);
    margin-bottom: 4px;
}

.product-info .price {
    font-family: 'Poppins', sans-serif;
    color: var(--accent);
    font-weight: 600;
}

/* Overlay */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    backdrop-filter: blur(4px);
    background: rgba(0,0,0,0.3);
    z-index: 900;
}

/* Expanded card */
.expanded-card {
    position: fixed;
    top: 100px; /* below header */
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 500px;
    background: var(--card-bg);
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    border-radius: 12px;
    padding: 16px;
    z-index: 1000;
    overflow-y: auto;
    max-height: 80vh;
}

/* Close button */
.expanded-card .close-btn {
    position: absolute;
    top: 8px;
    left: 8px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: var(--muted);
    background: rgba(255,255,255,0.8);
    border-radius: 50%;
    width: 36px;
    height: 36px;
    line-height: 32px;
    text-align: center;
}

/* Buttons inside expanded card */
.expanded-card .buttons {
    display: flex;
    justify-content: flex-start;
    gap: 10px;
    margin-top: 16px;
}

.btn.primary { background: var(--primary); color: white; }
.btn.primary:hover { background: #6a302c; }
.btn.accent { background: var(--accent); color: white; }
.btn.accent:hover { background: #d4b76e; }

/* Empty state */
.empty {
    text-align: center;
    color: var(--muted);
    font-size: 1.1em;
    grid-column: 1 / -1;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function openModal(card) {
    const overlay = document.getElementById('modalOverlay');

    // Remove any previous expanded card
    const prev = document.querySelector('.expanded-card');
    if (prev) prev.remove();

    // Build expanded card content
    const expanded = document.createElement('div');
    expanded.className = 'expanded-card';

    expanded.innerHTML = `
        <span class="close-btn" onclick="closeModal(event)">&times;</span>
        <div class="product-image">
            <img src="${card.dataset.image}" alt="${card.dataset.name}">
        </div>
        <div class="product-info">
            <h3>${card.dataset.name}</h3>
            <p class="price">₱${card.dataset.price}</p>
            <p class="description">${card.dataset.description}</p>
        </div>
        <div class="buttons">
            <form action="/add_to_cart/${card.dataset.id}" method="POST">
                <button class="btn primary" type="submit">Add to Cart</button>
            </form>
            <form action="/buy_now/${card.dataset.id}" method="POST">
                <button class="btn accent" type="submit">Buy Now</button>
            </form>
        </div>
    `;

    document.body.appendChild(expanded);
    overlay.style.display = 'block';
}

function closeModal(event) {
    if (event) event.stopPropagation(); // prevent overlay click from triggering twice
    const expanded = document.querySelector('.expanded-card');
    const overlay = document.getElementById('modalOverlay');
    if (expanded) expanded.remove();
    overlay.style.display = 'none';
}
</script>
{% endblock %}
